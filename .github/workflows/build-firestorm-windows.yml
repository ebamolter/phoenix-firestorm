name: Build Firestorm Windows

on:
  workflow_dispatch:
    inputs:
      branch_or_tag:
        description: 'Branch or tag to build (例: 7.2.0_preview / Firestorm_7.1.13)'
        required: true
        default: '7.2.0_preview'
      do_package:
        description: 'Create installer/package? (容量・時間が増大します)'
        required: true
        default: 'false'

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout phoenix-firestorm
        uses: actions/checkout@v4
        with:
          repository: FirestormViewer/phoenix-firestorm
          ref: ${{ github.event.inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Enable Git long paths
        run: git config --system core.longpaths true
        shell: bash

      # 追加：fs-build-variables を取得（Windowsでも必要だった）
      - name: Clone fs-build-variables
        shell: bash
        run: |
          mkdir -p "$HOME/src"
          cd "$HOME/src"
          git clone https://github.com/FirestormViewer/fs-build-variables.git

      # 追加：AUTOBUILD_VARIABLES_FILE を全ステップに反映
      - name: Set AUTOBUILD_VARIABLES_FILE
        shell: bash
        run: echo "AUTOBUILD_VARIABLES_FILE=$HOME/src/fs-build-variables/variables" >> "$GITHUB_ENV"

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Autobuild
        run: |
          python -m pip install --upgrade pip
          python -m pip install autobuild

      - name: Configure Firestorm
        shell: cmd
        run: |
          autobuild configure -A 64 -c ReleaseFS_open

      - name: Build Firestorm
        shell: cmd
        run: |
          autobuild build -A 64 -c ReleaseFS_open --no-configure

      - name: Package Firestorm (optional)
        if: ${{ github.event.inputs.do_package == 'true' }}
        shell: cmd
        run: |
          autobuild package -A 64 -c ReleaseFS_open

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firestorm-windows
          path: |
            build-vc*-64\newview\packaged
            build-vc*-64\newview\ReleaseFS_open
